<!DOCTYPE html>
<html lang="fr" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.111.3">
    <meta name="description" content="">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Capture and pre process image :: Documentation du thème Hugo Learn</title>

    
    <link href="/css/nucleus.css?1720161094" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1720161094" rel="stylesheet">
    <link href="/css/hybrid.css?1720161094" rel="stylesheet">
    <link href="/css/featherlight.min.css?1720161094" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1720161094" rel="stylesheet">
    <link href="/css/auto-complete.css?1720161094" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1720161094" rel="stylesheet">
    <link href="/css/theme.css?1720161094" rel="stylesheet">
    <link href="/css/tabs.css?1720161094" rel="stylesheet">
    <link href="/css/hugo-theme.css?1720161094" rel="stylesheet">
    
    <link href="/css/theme-red.css?1720161094" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1720161094"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/fr/development/capture-app/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <img src="/images/logo.svg" />

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Rechercher...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1720161094"></script>
<script type="text/javascript" src="/js/auto-complete.js?1720161094"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/rivieradev2024-crazytrain.netlify.app\/\/fr";
    
</script>
<script type="text/javascript" src="/js/search.js?1720161094"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/fr/overview/" title="Présentation" class="dd-item
        
        
        
        ">
      <a href="/fr/overview/">
          <b>1. </b>Présentation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/fr/overview/goal/" title="Objectif" class="dd-item ">
        <a href="/fr/overview/goal/">
        Objectif
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/overview/architecture/" title="Architecture" class="dd-item ">
        <a href="/fr/overview/architecture/">
        Architecture
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/overview/organization/" title="Organisation" class="dd-item ">
        <a href="/fr/overview/organization/">
        Organisation
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/overview/openshift/" title="OpenShift" class="dd-item ">
        <a href="/fr/overview/openshift/">
        OpenShift
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/fr/ai/" title="Intelligence Artificielle (1h)" class="dd-item
        
        
        
        ">
      <a href="/fr/ai/">
          <b>2. </b>Intelligence Artificielle (1h)
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/fr/development/" title="Développement (30min)" class="dd-item
        parent
        
        
        ">
      <a href="/fr/development/">
          <b>3. </b>Développement (30min)
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/fr/development/introduction/" title="Introduction" class="dd-item ">
        <a href="/fr/development/introduction/">
        Introduction
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/capture-app/" title="Capture and pre process image" class="dd-item active">
        <a href="/fr/development/capture-app/">
        Capture and pre process image
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/intelligent-train/" title="Predict command" class="dd-item ">
        <a href="/fr/development/intelligent-train/">
        Predict command
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/train-ceq-app/" title="Post process image" class="dd-item ">
        <a href="/fr/development/train-ceq-app/">
        Post process image
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/monitoring-app/" title="Monitoring" class="dd-item ">
        <a href="/fr/development/monitoring-app/">
        Monitoring
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/start-services/" title="Start services" class="dd-item ">
        <a href="/fr/development/start-services/">
        Start services
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/test-services/" title="Test services" class="dd-item ">
        <a href="/fr/development/test-services/">
        Test services
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/development/conclusion/" title="Conclusion" class="dd-item ">
        <a href="/fr/development/conclusion/">
        Conclusion
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/fr/devops/" title="DevOps (30min)" class="dd-item
        
        
        
        ">
      <a href="/fr/devops/">
          <b>4. </b>DevOps (30min)
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/fr/devops/ci-cd/" title="Pipelines CI/CD" class="dd-item ">
        <a href="/fr/devops/ci-cd/">
        Pipelines CI/CD
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/fr/devops/gitops/" title="GitOps" class="dd-item ">
        <a href="/fr/devops/gitops/">
        GitOps
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="https://rivieradev2024-crazytrain.netlify.app/development/capture-app/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="fr" value="https://rivieradev2024-crazytrain.netlify.app/fr/development/capture-app/" selected>Français</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Supprimer l&#39;historique</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/fr/'>Welcome</a> > <a href='/fr/development/'>Développement (30min)</a> > Capture and pre process image
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents"></nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Capture and pre process image
            </h1>
          

        


<p><strong>capture-app</strong> est construite avec Quarkus, un framework Java complet, natif de Kubernetes, conçu pour les machines virtuelles Java (JVM) et la compilation native, optimisant Java spécifiquement pour les conteneurs et lui permettant de devenir une plateforme efficace pour les environnements serverless, cloud et Kubernetes.</p>
<p>La fonctionnalité principale du microservice <strong>capture-app</strong> est de contrôler la capture vidéo. Elle offre la possibilité de démarrer et d&rsquo;arrêter le streaming vidéo, via des points de terminaison RESTful exposés. Ces points de terminaison peuvent être appelés à partir de n&rsquo;importe quel client http (comme un navigateur web ou une commande curl dans un terminal).</p>
<p>Dans le projet <strong>capture-app</strong>, vous allez ajouter deux nouvelles propriétés dans le fichier <strong>application.properties</strong> et modifier la classe <strong>ScheduledCapture.java</strong> pour charger ces propriétés.</p>
<ol>
<li><strong>Modifier le fichier de configuration</strong> : Ouvrez le fichier de configuration de votre application. Il s&rsquo;agit du fichier nommé <code>src/main/resources/application.properties</code>. Ajoutez les propriétés suivantes :</li>
<li>Ajoutez les deux nouvelles propriétés à la fin du fichier :</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">%dev.capture.mock</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">%dev.capture.videoPath</span><span style="color:#f92672">=</span><span style="color:#e6db74">/projects/rivieradev-app/capture-app/src/main/resources/videos/track-christmas-tree.avi</span>
</span></span></code></pre></div><ol start="3">
<li>
<p>Enregistrez vos modifications.</p>
</li>
<li>
<p>Ouvrez le fichier <code>src/main/java/org/redhat/demo/crazytrain/captureimage/ScheduledCapture.java</code>.</p>
</li>
<li>
<p>Ajoutez les annotations <code>@ConfigProperty</code> pour charger les nouvelles propriétés. Ajoutez ces lignes en haut de la classe, juste en dessous de la déclaration de la classe :</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.mock&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">boolean</span> mock<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.videoPath&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>String videoPath<span style="color:#f92672">;</span>
</span></span></code></pre></div><ol start="6">
<li>Vérification du code</li>
</ol>
<p>La classe <strong>src/main/java/com/train/capture/app/ScheduledCapture.java</strong> devrait ressembler à :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#f92672">package</span> org.redhat.demo.crazytrain.captureimage<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.enterprise.context.ApplicationScoped<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.enterprise.event.Observes<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.inject.Inject<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.ws.rs.GET<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.ws.rs.POST<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.ws.rs.Path<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.ws.rs.core.Response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jakarta.ws.rs.core.Response.ResponseBuilder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.ArrayList<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.eclipse.microprofile.config.inject.ConfigProperty<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.eclipse.paho.client.mqttv3.MqttException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.jboss.logging.Logger<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.opencv.core.Mat<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.opencv.core.Size<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.opencv.imgproc.Imgproc<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.opencv.videoio.VideoCapture<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.opencv.videoio.Videoio<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.redhat.demo.crazytrain.mqtt.MqttPublisher<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.redhat.demo.crazytrain.util.Util<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.quarkus.runtime.StartupEvent<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.quarkus.scheduler.Scheduled<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.vertx.mutiny.core.Vertx<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ScheduledCapture is a service that captures images from a camera using the OpenCV library
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ApplicationScoped</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Path</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/capture&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduledCapture</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span>  VideoCapture camera<span style="color:#f92672">;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.mock&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> mock<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.videoPath&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    String videoPath<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// interval in milliseconds
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.interval&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> interval<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// tmpFolder is the folder where the images are saved
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.tmpFolder&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>    String tmpFolder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// broker is the MQTT broker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.brokerMqtt&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    String broker<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// topic is the MQTT topic
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.topic&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    String topic<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// nbImgSec is the number of images captured every second
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.periodicCapture&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> periodicCapture<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.saveImage&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> saveImage<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.videoDeviceIndex&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> videoDeviceIndex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ConfigProperty</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;capture.videoPeriodicCapture&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> videoPeriodicCapture<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Inject</span>
</span></span><span style="display:flex;"><span>    ImageCaptureService imageCaptureService<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Inject</span>
</span></span><span style="display:flex;"><span>    ImageService imageService<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Inject</span>
</span></span><span style="display:flex;"><span>    Vertx vertx<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MqttPublisher mqttPublisher <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long timerId<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> stopRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Thread testThread<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger LOGGER <span style="color:#f92672">=</span> Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>ScheduledCapture<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Util util <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isStopRequested</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> stopRequested<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setStopRequested</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> stopRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">stopRequested</span> <span style="color:#f92672">=</span> stopRequested<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Start the camera when the application starts and set the resolution
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onStart</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Observes</span> StartupEvent ev<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>ScheduledCapture<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">).</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;The application is starting...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(!</span>mock<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            camera <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> VideoCapture<span style="color:#f92672">(</span>videoDeviceIndex<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>            camera<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Videoio<span style="color:#f92672">.</span><span style="color:#a6e22e">CAP_PROP_FRAME_WIDTH</span><span style="color:#f92672">,</span> 640<span style="color:#f92672">);</span> <span style="color:#75715e">// Max resolution for Logitech C505
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            camera<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Videoio<span style="color:#f92672">.</span><span style="color:#a6e22e">CAP_PROP_FRAME_HEIGHT</span><span style="color:#f92672">,</span> 480<span style="color:#f92672">);</span> <span style="color:#75715e">// Max resolution for Logitech C505
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            camera<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Videoio<span style="color:#f92672">.</span><span style="color:#a6e22e">CAP_PROP_EXPOSURE</span><span style="color:#f92672">,</span> 15<span style="color:#f92672">);</span> <span style="color:#75715e">// Try to set exposure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        util <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Util<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        mqttPublisher <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MqttPublisher<span style="color:#f92672">(</span>broker<span style="color:#f92672">.</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">(),</span> topic<span style="color:#f92672">.</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readVideo</span><span style="color:#f92672">(</span>String videoPath<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        
</span></span><span style="display:flex;"><span>        VideoCapture capture <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> VideoCapture<span style="color:#f92672">(</span>videoPath<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>capture<span style="color:#f92672">.</span><span style="color:#a6e22e">isOpened</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Video file not found at &#34;</span> <span style="color:#f92672">+</span> videoPath<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">double</span> fps <span style="color:#f92672">=</span> capture<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>Videoio<span style="color:#f92672">.</span><span style="color:#a6e22e">CAP_PROP_FPS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> frameSkip <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>fps<span style="color:#f92672">/</span>8<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        Mat frame <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Mat<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>stopRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// Continue reading the video until a stop request is received
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>capture<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>frame<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">%</span> frameSkip <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Publish the image to the MQTT broker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">long</span> timestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>util <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">long</span> start2 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                        String jsonMessage <span style="color:#f92672">=</span> util<span style="color:#f92672">.</span><span style="color:#a6e22e">matToJson</span><span style="color:#f92672">(</span>frame<span style="color:#f92672">,</span> timestamp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">long</span> end2 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time to convert image to json: %d ms&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span>end2 <span style="color:#f92672">-</span> start2<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 1000000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;JSON Message with id %s&#34;</span><span style="color:#f92672">,</span> jsonMessage<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">long</span> start3 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                            mqttPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">publish</span><span style="color:#f92672">(</span>jsonMessage<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">long</span> end3 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time to publish image: %d ms&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span>end3 <span style="color:#f92672">-</span> start3<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 1000000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Message with id %s published to topic: %s&#34;</span><span style="color:#f92672">,</span> timestamp<span style="color:#f92672">,</span> topic<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>MqttException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>saveImage<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                        String filepath <span style="color:#f92672">=</span> tmpFolder<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> timestamp <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.jpg&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                        imageService<span style="color:#f92672">.</span><span style="color:#a6e22e">saveImageAsync</span><span style="color:#f92672">(</span>frame<span style="color:#f92672">,</span> filepath<span style="color:#f92672">).</span><span style="color:#a6e22e">thenAccept</span><span style="color:#f92672">(</span>success <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>success<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Frame saved successfully&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to save frame&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                count<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stopRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// Check if stop has been requested inside the inner loop as well
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            capture<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Videoio<span style="color:#f92672">.</span><span style="color:#a6e22e">CAP_PROP_POS_FRAMES</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span> <span style="color:#75715e">// Reset the video to the first frame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        capture<span style="color:#f92672">.</span><span style="color:#a6e22e">release</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Capture and save a defined number of images every second
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">captureAndSaveImage</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;The Thread name is %s&#34;</span> <span style="color:#f92672">+</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Capture the image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            Mat image <span style="color:#f92672">=</span> imageCaptureService<span style="color:#f92672">.</span><span style="color:#a6e22e">captureImage</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">camera</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">long</span> end <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time to capture image: %d ms&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span>end <span style="color:#f92672">-</span> start<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 1000000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Publish the image to the MQTT broker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">long</span> timestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>util <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">long</span> start2 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                String jsonMessage <span style="color:#f92672">=</span> util<span style="color:#f92672">.</span><span style="color:#a6e22e">matToJson</span><span style="color:#f92672">(</span>image<span style="color:#f92672">,</span> timestamp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">long</span> end2 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time to convert image to json: %d ms&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span>end2 <span style="color:#f92672">-</span> start2<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 1000000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;JSON Message with id %s&#34;</span><span style="color:#f92672">,</span> jsonMessage<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">long</span> start3 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    mqttPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">publish</span><span style="color:#f92672">(</span>jsonMessage<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#75715e">// Check if stop has been requested
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stopRequested<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// Stop capture and release camera
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        vertx<span style="color:#f92672">.</span><span style="color:#a6e22e">cancelTimer</span><span style="color:#f92672">(</span>timerId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        timerId <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                        imageCaptureService<span style="color:#f92672">.</span><span style="color:#a6e22e">releaseCamera</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">camera</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        mqttPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">disconnect</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Capture stopped&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">long</span> end3 <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">nanoTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time to publish image: %d ms&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span>end3 <span style="color:#f92672">-</span> start3<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> 1000000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debugf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Message with id %s published to topic: %s&#34;</span><span style="color:#f92672">,</span> timestamp<span style="color:#f92672">,</span> topic<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>MqttException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Save the image to the file system (asynchronously)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>saveImage<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                String filepath <span style="color:#f92672">=</span> tmpFolder<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> timestamp <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.jpg&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                imageService<span style="color:#f92672">.</span><span style="color:#a6e22e">saveImageAsync</span><span style="color:#f92672">(</span>image<span style="color:#f92672">,</span> filepath<span style="color:#f92672">).</span><span style="color:#a6e22e">thenAccept</span><span style="color:#f92672">(</span>success <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>success<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Image saved successfully&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to save image&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@POST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Path</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/start&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Capture started&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        stopRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        mqttPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">connect</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//captureEnabled = true;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timerId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Response<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">(</span>Response<span style="color:#f92672">.</span><span style="color:#a6e22e">Status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BAD_REQUEST</span><span style="color:#f92672">).</span><span style="color:#a6e22e">entity</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Capture is already running&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        timerId <span style="color:#f92672">=</span> vertx<span style="color:#f92672">.</span><span style="color:#a6e22e">setPeriodic</span><span style="color:#f92672">(</span>periodicCapture<span style="color:#f92672">,</span> id <span style="color:#f92672">-&gt;</span> captureAndSaveImage<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Response<span style="color:#f92672">.</span><span style="color:#a6e22e">ok</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Capture started&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@POST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Path</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/test&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">test</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Test started&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        stopRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        mqttPublisher<span style="color:#f92672">.</span><span style="color:#a6e22e">connect</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timerId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Response<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">(</span>Response<span style="color:#f92672">.</span><span style="color:#a6e22e">Status</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BAD_REQUEST</span><span style="color:#f92672">).</span><span style="color:#a6e22e">entity</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Capture is already running&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        testThread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> readVideo<span style="color:#f92672">(</span>videoPath<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        testThread<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Response<span style="color:#f92672">.</span><span style="color:#a6e22e">ok</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;read video from file started&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@POST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Path</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/stop&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">stop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stopRequested <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        LOGGER<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stop requested&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>testThread <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                testThread<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">();</span> <span style="color:#75715e">// Wait for the testThread to finish
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                testThread <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span> <span style="color:#75715e">// Restore interrupted status
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Response<span style="color:#f92672">.</span><span style="color:#a6e22e">ok</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stop requested&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>       
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Le fichier <strong>application.properties</strong> devrait ressembler à :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#a6e22e">%dev.quarkus.http.port</span><span style="color:#f92672">=</span><span style="color:#e6db74">8082</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">%dev.catpure.videoPeriodicCapture</span><span style="color:#f92672">=</span><span style="color:#e6db74">30</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">quarkus.kafka.devservices.enabled</span><span style="color:#f92672">=</span><span style="color:#e6db74">false</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">quarkus.swagger-ui.always-include</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.videoDeviceIndex</span><span style="color:#f92672">=</span><span style="color:#e6db74">${VIDE0_DEVICE_INDEX:0}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.dropbox.token</span><span style="color:#f92672">=</span><span style="color:#e6db74">${DROPBOX_TOKEN:null}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.tmpFolder</span><span style="color:#f92672">=</span><span style="color:#e6db74">${TMP_FOLDER:/Users/mouchan/crazy-train-images}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.interval</span><span style="color:#f92672">=</span><span style="color:#e6db74">${INTERVAL:100}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.periodicCapture</span><span style="color:#f92672">=</span><span style="color:#e6db74">${PERIODIC_CAPTURE:30}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.brokerMqtt</span><span style="color:#f92672">=</span><span style="color:#e6db74">${MQTT_BROKER:tcp://localhost:1883}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.topic</span><span style="color:#f92672">=</span><span style="color:#e6db74">${MQTT_TOPIC:train-image}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.videoPath</span><span style="color:#f92672">=</span><span style="color:#e6db74">${VIDEO_PATH:/projects/rivieradev-app/capture-app/src/main/resources/videos/track-christmas-tree.avi}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.videoPeriodicCapture</span><span style="color:#f92672">=</span><span style="color:#e6db74">${VIDEO_PERIODIC_CAPTURE:30}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.saveImage</span><span style="color:#f92672">=</span><span style="color:#e6db74">${SAVE_IMAGE:false}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">capture.mock</span><span style="color:#f92672">=</span><span style="color:#e6db74">${MOCK:false}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">quarkus.log.level</span><span style="color:#f92672">=</span><span style="color:#e6db74">${LOGGER_LEVEL:INFO}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">%dev.capture.mock</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">%dev.catpure.videoPath</span><span style="color:#f92672">=</span><span style="color:#e6db74">/projects/rivieradev-app/capture-app/src/main/resources/videos/track-christmas-tree.avi</span>
</span></span></code></pre></div><ol start="7">
<li>Compilation du projet</li>
</ol>
<p>Avant de committer vos modifications, vous devez construire le projet  pour vous assurer qu&rsquo;il n&rsquo;y a pas d&rsquo;erreurs de compilation.</p>
<ul>
<li>Ouvrez un nouveau terminal</li>
</ul>
<p><img src="/images/dev-section/first-terminal.png" alt="first terminal"></p>
<ul>
<li>Lancez les commandes ci-dessous</li>
</ul>
<pre tabindex="0"><code>cd capture-app
mvn clean package
</code></pre><p>Vérifiez qu&rsquo;il n&rsquo;existe aucune erreur et fermez le terminal.</p>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/fr/development/introduction/" title="Introduction"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/fr/development/intelligent-train/" title="Predict command" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1720161094"></script>
    <script src="/js/perfect-scrollbar.min.js?1720161094"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1720161094"></script>
    <script src="/js/jquery.sticky.js?1720161094"></script>
    <script src="/js/featherlight.min.js?1720161094"></script>
    <script src="/js/highlight.pack.js?1720161094"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1720161094"></script>
    <script src="/js/learn.js?1720161094"></script>
    <script src="/js/hugo-learn.js?1720161094"></script>
    
        
            <script src="/mermaid/mermaid.js?1720161094"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

